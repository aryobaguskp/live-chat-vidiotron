<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Admin Dashboard – Live Chat Café</title>
<script src="/socket.io/socket.io.js"></script>

<style>
body{
  margin:0;
  font-family:"Segoe UI",Arial,sans-serif;
  background:#0f0f0f;
  color:#fff;
}

/* LOGIN */
#login{
  max-width:380px;
  margin:120px auto;
  background:#181818;
  padding:35px;
  border-radius:16px;
}
input{
  width:100%;
  padding:12px;
  margin-top:10px;
  border:none;
  border-radius:8px;
}
button{
  padding:10px 16px;
  background:#cfa35a;
  border:none;
  border-radius:8px;
  cursor:pointer;
}
button.secondary{background:#444}
#error{color:#ff7070;margin-top:10px;text-align:center}

/* DASHBOARD */
#dashboard{display:none}

#topbar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:18px 30px;
  background:#141414;
  border-bottom:1px solid #222;
}
#brand{
  display:flex;
  align-items:center;
  gap:14px;
}
#brand img{height:40px}

#content{
  padding:30px;
}

#list{
  max-width:900px;
  margin:auto;
}

/* CARD */
.card{
  background:#202020;
  padding:18px;
  border-radius:14px;
  margin-bottom:16px;
}
.card b{color:#ffd27d}
.status{font-size:13px;opacity:.7;margin-top:6px}
.actions{margin-top:12px}
.actions button{margin-right:8px}

.empty{
  text-align:center;
  opacity:.5;
  margin-top:80px;
  font-size:18px;
}

/* OPACITY BOX */
#bg-setting{
  max-width:900px;
  margin:0 auto 25px auto;
  background:#1a1a1a;
  padding:16px;
  border-radius:12px;
}
#bg-setting label{
  font-size:13px;
  opacity:.7;
}

/* ===== CONNECTION STATUS ===== */
#connStatus{
  font-size:13px;
  padding:6px 12px;
  border-radius:20px;
  font-weight:600;
  letter-spacing:.5px;
}

#connStatus.online{
  background:#1e3d2b;
  color:#4dff9a;
}

#connStatus.reconnecting{
  background:#3d3520;
  color:#ffd27d;
}

#connStatus.offline{
  background:#3d1e1e;
  color:#ff7070;
}

#top-actions select{
  padding:8px 10px;
  border-radius:8px;
  border:none;
  background:#2a2a2a;
  color:#fff;
  font-size:13px;
  margin-right:8px;
}


</style>
</head>

<body>

<!-- LOGIN -->
<div id="login">
  <h2 style="text-align:center">Admin Login</h2>
  <input id="pass" type="password" placeholder="Password admin">
  <button style="width:100%;margin-top:15px" onclick="login()">Masuk Dashboard</button>
  <div id="error"></div>
</div>

<!-- DASHBOARD -->
<div id="dashboard">

  <div id="topbar">
  <div id="brand">
    <img src="logo.png">
    <h1>Live Chat Café – Admin</h1>
  </div>
  <div id="connStatus" class="status online">
    ● ONLINE
  </div>
  <div id="top-actions">
    <button id="btnApproveAll" onclick="approveAll()">Approve Semua</button>
    <button class="secondary" onclick="deleteAll()">Delete Semua</button>
    <button class="secondary" onclick="logout()">Logout</button>
  </div>
</div>


  <div id="content">

    <!-- ✅ SETTING OPACITY (AMAN) -->
    <div id="bg-setting">
      <label>Opacity Background Display</label>
      <input
        type="range"
        id="bgOpacity"
        min="0"
        max="0.9"
        step="0.05"
        value="0.55"
        style="width:100%"
      >
    </div>

    <!-- LIST PESAN -->
    <div id="list"></div>

  </div>
</div>

<script>
const socket = io({
  reconnection: true,
  reconnectionAttempts: Infinity,
  reconnectionDelay: 1000
});


/* ELEMENT */
const loginBox = document.getElementById("login");
const dashboardBox = document.getElementById("dashboard");
const list = document.getElementById("list");
const errorBox = document.getElementById("error");
const btnApproveAll = document.getElementById("btnApproveAll");
const bgOpacity = document.getElementById("bgOpacity");
const connStatus = document.getElementById("connStatus");


let busy = false;

/* LOGIN */
function login(){
  errorBox.innerText="";
  socket.emit("admin-login", document.getElementById("pass").value);
}
function logout(){
  location.reload();
}

socket.on("login-success",()=>{
  loginBox.style.display="none";
  dashboardBox.style.display="block";
});
socket.on("login-failed",()=>{
  errorBox.innerText="Password salah";
});

/* OPACITY SYNC */
bgOpacity.oninput = ()=>{
  socket.emit(
    "set-display-bg-opacity",
    parseFloat(bgOpacity.value)
  );
};

socket.on("display-bg-opacity",(val)=>{
  bgOpacity.value = val;
});

/* RENDER */
socket.on("admin-refresh",(msgs)=>{
  busy=false;
  btnApproveAll.disabled=false;
  render(msgs);
});

function render(msgs){
  list.innerHTML="";
  if(msgs.length===0){
    list.innerHTML='<div class="empty">Belum ada pesan</div>';
    return;
  }

  msgs.forEach(m=>{
    const div=document.createElement("div");
    div.className="card";
    div.innerHTML=`
      <b>${m.username}</b><br>
      ${m.message}
      <div class="status">
        Status: ${m.approved?"✅ Approved":"⏳ Pending"}
      </div>
      <div class="actions">
        <button onclick="approve(${m.id})">Approve</button>
        <button class="secondary" onclick="rejectMsg(${m.id})">Reject</button>
        <button class="secondary" onclick="deleteMsg(${m.id})">Delete</button>
      </div>
    `;
    list.appendChild(div);
  });
}

/* ACTIONS */
function approve(id){
  if(busy) return;
  busy=true;
  socket.emit("approve-message",id);
}
function rejectMsg(id){
  if(confirm("Reject pesan ini?")){
    socket.emit("reject-message",id);
  }
}
function deleteMsg(id){
  if(confirm("Hapus pesan ini?")){
    socket.emit("delete-message",id);
  }
}
function approveAll(){
  if(busy) return;
  if(confirm("Approve semua pesan?")){
    busy=true;
    btnApproveAll.disabled=true;
    socket.emit("approve-all");
  }
}
function deleteAll(){
  if(confirm("⚠️ Hapus SEMUA pesan? Tindakan ini tidak bisa dibatalkan!")){
    socket.emit("delete-all-messages");
  }
}


/* ===== STATUS SOCKET ===== */
socket.on("connect",()=>{
  connStatus.className = "online";
  connStatus.innerText = "● ONLINE";
  socket.emit("admin-reconnect");
});

socket.on("disconnect",()=>{
  connStatus.className = "offline";
  connStatus.innerText = "● OFFLINE";
});

socket.io.on("reconnect_attempt",()=>{
  connStatus.className = "reconnecting";
  connStatus.innerText = "● RECONNECTING…";
});

// sync saat reconnect
socket.on("chat-layout",(mode)=>{
  chatLayout.value = mode;
});

</script>

</body>
</html>
